## 1차 캐시 vs 2차 캐시

1차/2차 캐시를 사용하는 이유는 네트워크를 통해 DB에 접근하는 시간 비용을 줄이기 위함이다.

<br>

### 1차 캐시란

영속성 컨텍스트 내부에서 엔티티를 보관하는 장소를 말한다.

엔티티 매니저로 조회하거나 변경하는 엔티티는 1차 캐시에 저장된다. (on-off할 수 있는 옵션이 아니다.)

> 영속성 컨텍스트 내부에 MAP이 있는데, 키는 @Id로 매핑한 식별자이고, 값은 엔티티 인스턴스이다.

일반적으로는 트랜잭션 범위에서만 적용되기 때문에 성능상 큰 이점이 있지는 않다. (OSIV를 적용하면 요청 범위의 캐시를 제공한다.)

#### 쓰기 지연

엔티티가 영속상태가 되려면 식별자가 꼭 필요하다. 따라서 생성 전략이 IDENTITY로 된 엔티티는 즉시 insert문을 실행하며, 쓰기 지연을 활용한 성능 최적화를 할 수 없다.

쓰기 지연이란, 트랜잭션이 종료될 때까지 SQL 저장소에 쿼리문을 저장해 두는 것이다.

1차 캐시 안에는 스냅샷(최초로 1차 캐시에 들어온 상태)를 저장해 두기 때문에 트랜잭션을 커밋하는 시점에 스냅샷과 비교하여 바뀐 것이 있다면 UPDATE 쿼리를 SQL 저장소에 만들어 둔다.

<br>

### 2차 캐시

하이버네이트를 포함한 대부분의 JPA 구현체에서 제공하는 애플리케이션 범위의 캐시이다.

1차 캐시에 저장되어 있지 않은 엔티티가 필요하면 2차 캐시에서 먼저 조회한 후 없으면 데이터베이스에 접근한다.

동시성을 극대화하기 위해 캐시한 객체를 직접 반환하지 않고 복사본을 만들어서 반환한다.

2차 캐시를 사용하려면 엔티티에 `@Cachable` 어노테이션을 사용해야 한다.

