## Docker Swarm

#### 도커 스웜 설명

**Docker Swarm**은 여러 컨테이너를 클러스터로 만들어 관리한다. 

Docker를 사용한 오케스트레이션 인프라를 구축할 때 가장 호환성이 좋다.

+ 오케스트레이션이란?

  여러 대의 서버와 여러 개의 서비스를 편리하게 관리해주는 작업이다.

  + **스케줄링**

    컨테이너를 적당한 서버에 배포해주는 작업이다.

  + **클러스터링**

    여러 개의 서버를 하나의 서버처럼 사용할 수 있다. 여기저기 흩어져 있는 컨테이너도 가상 네트워크를 이용하여 마치 같은 서버에 있는 것처럼 쉽게 통신할 수 있다.

  + 서비스 디스커버리

    클러스터 환경에서 컨테이너가 어느 서버에 생성될 지 알 수 없고, 다른 서버로 이동할 수도 있기 때문에 말 그대로 서비스를 찾아준다.

  + 로깅, 모니터링

    ELK와 prometheus 등 다양한 툴을 사용하여 로그와 서버 상태를 한 곳에서 관리한다.

<br>

#### Docker swarm vs Kubernetes

| Tool         | 장점                                                         | 단점                                                         |
| ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Docker Swarm | + Docker의 모든 기능이 내장되어 있다.<br />+ 별도의 툴 설치가 필요하지 않다.<br />+ 타 Ochestration Tool에 비해 다루기 쉽다. | + 다른 도구에 비해 기능이 단순하다.<br />+ 초대형 노드 클러스터링에는 무리 |
| Kubernetes   | + 현재 가장 많이 쓰이고 있는 틀이다.<br>+ 내장된 기능이 많아 다른 툴을 설치할 경우가 적다. | + 구성과 개념 이해에 높은 이해가 필요하다.<br>+ 소규모 프로젝트에서는 구축하기 쉽지 않다. |

<br>

#### 도커 스웜 용어

+ `이미지`

  서비스 운영에 필요한 서버 프로그램, 소스 코드 및 라이브러리, 컴파일된 실행 파일을 묶는 형태.

+ `컨테이너` (도커 명령어의 제어 단위)

  이미지를 실행한 상태. 하나의 컨테이너에는 하나의 이미지가 들어간다.

+ `노드`

  스웜 클러스터에 속한 도커 서버의 단위. 보통 한 서버에 하나의 도커데몬만 실행하므로 서버가 곧 노드라고 이해하면 된다.

  > Docker Daemon : 
  >
  > 도커는 클라이언트로서의 도커와 서버로서의 도커로 나뉜다. 실제로 컨테이너를 생성하고 실행하며 이미지를 관리하는 주체는 서버도커이고, 이는 docker 프로세스로서 동작한다.
  >
  > 도커 프로세스가 실행되어 서버로서 입력을 받을 준비가 된 상태를 도커 데몬이라고 한다.

+ `매니저노드`

  스웜 클러스터 상태를 관리. 매니저 노드는 곧 워커노드가 될 수 있고, 스웜 명령어는 매니저 노드에서만 실행됨.

+ `워커노드`

  매니저 노드의 명령을 받아 컨테이너를 생성하고 상태를 체크하는 노드.

+ `서비스` (스웜모드 명령어의 제어 단위)

  기본적인 배포 단위. 하나의 서비스는 하나의 이미지를 기반으로 생성한다.

  서비스 내에 컨테이너는 한 개 이상 존재할 수 있으며, 컨테이너들은 각 워커 노드와 매니저 노드에 할당된다. 각 노드에 할당된 컨테이너들을 태스크라고 한다.

+ `태스크`

  컨테이너의 배포 단위. 하나의 서비스는 여러 개의 태스크를 실행할 수 있고 각각의 태스크가 컨테이너를 관리한다.

+ `Ingress Network`

  도커 스웜은 서비스를 외부에 쉽게 노출하기 위해 모든 노드를 ingress라는 가상 네트워크에 올려둔다.

<br>

#### 실사용

EC2에 Docker를 다운받은 후에 `docker swarm init` 명령어를 통해 docker swarm을 적용시켜야 한다.

Docker swarm을 GUI 형태로 확인할 수 있는 도구가 swarmpit.io이다.

> swarmpit의 기본 포트는 888이며, EC2 인바인드 규칙에 추가해야 한다.

swarmpit에 접근하기 위해서는 도커에 회원가입해야 한다. 

swarmpit 설정이 끝나면 `EC2 IP 주소:swarmpit 포트`를 통해 접속하면 된다.

> Create Service - Deployment에서 Autoredeploy를 체크하면 CD가 자동으로 이루어지면서 swarmpit service에 변경된 코드가 적용된다. > github action을 따로 설정하지 않아도 된다.

+ 설정할 때 참고할 사이트

https://velog.io/@hanif/Deploy-Github-Action%EA%B3%BC-Docker-Swarm%EC%9C%BC%EB%A1%9C-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0?fbclid=IwAR3cxUm50MftWDvDc8Gn_IhOQyiYQHhzC4Oz4YUwlQigBZXwJxtv_Nh5Rss

